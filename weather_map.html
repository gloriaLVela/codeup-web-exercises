<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>weather_map</title>
    <script src="js/keys.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet'/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="js/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
            integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
            integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
            crossorigin="anonymous"></script>

    <style>
        /* give the map a defined size */
        body {
            background-color: #B4DBFA;
        }

        td {
            background-color: #F2F2F2;
        }

        #map {
            width: 90%;
            height: 350px;
        }
    </style>
</head>
<body>
<div class="container">
    <div><h2>Weather Application</h2></div>
    <div><h3 id="currentLocation">San Antonio</h3><br>
        <label for="lng">Lng<input type="text" id="lng"></label>
        <label for="lat">Lat<input type="text" id="lat"></label><br>
        <input id="search" type="button" value="Search">
    </div>
    <div id="forecast" class="row"></div>
    <!-- define HTML element for map -->
    <div id='map'></div>
</div>

<!-- the required script for Mapbox -->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>

<!-- the script for geocoding from the curriculum -->
<script src="js/mapbox-utils.js"></script>


<!-- script for working with the map -->
<script>

    $('document').ready()
    {

        // initial setting of map location

        let weatherIndex = [
            "clear-day", "clear-night", "rain", "snow", "sleet", "wind", "fog", "cloudy", "partly-cloudy-day", "partly-cloudy-night", "hail", "thunderstorm", "tornado"];

        let weatherIcon = [
            "icon/SVG/Sun.svg",
            "icon/SVG/Moon.svg",
            "icon/SVG/Cloud-Rain.svg",
            "icon/SVG/Cloud-Snow.svg",
            "icon/SVG/Cloud-Rain.svg",
            "icon/SVG/Cloud-Wind.svg",
            "icon/SVG/Cloud-Fog.svg",
            "icon/SVG/Cloud-Fog.svg",
            "icon/SVG/Cloud-Sun.svg",
            "icon/SVG/Cloud-Moon.svg",
            "icon/SVG/Cloud-Hail.svg",
            "icon/SVG/Cloud-Tornado.svg",
            "icon/SVG/Cloud-Tornado.svg"
        ];

        // var searchLocation = $('#currentLocation').innerHTML
        //
        // geocode(searchLocation, mapboxToken).then(function (result) {
        //     let newLocation = "";
        //     newLocation = result;
        //     getWeatherInfo(newLocation)
        //     drawMap(newLocation);
        //     //console.log("geocode");
        //     // });
        // });

        // a function to initially create a map
        var searchLocation = $('#currentLocation').html();
        console.log(searchLocation);

        geocode(searchLocation, mapboxToken).then(function (result) {
            let newLocation = "";
            newLocation = result;
            getWeatherInfo(newLocation)
            drawMap(newLocation);
            console.log("geocode");
            // });
        });

        function drawMap(location) {

            mapboxgl.accessToken = mapboxToken;
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v9',
                zoom: 10,
                center: location
            });
            return map;
        }


        $('#search').click(function () {
            let currentLocation = [];
            currentLocation.push($('#lng').val());
            currentLocation.push($('#lat').val());
            //Get the name of the location

            // reverse geocode method from mapbox-geocoder-utils.js
            var lng = $('#lng').val();
            var lat = $('#lat').val();
            // lng= -98.4861;
            // lat: 29.4260;
            reverseGeocode({lng: lng, lat: lat}, mapboxToken).then(function (results) {

                // logs the address for The Alamo(
                //console.log(results);
                $('#currentLocation').html(results);

                getWeatherInfo(currentLocation);
                drawMap(currentLocation);
                // $('#currentLocation').innerHTML = results;
            })

        });


        // }


        // the  geocode method from mapbox-geocoder-utils.js


        function getWeatherInfo(location) {

            // console.log(result);
            let weatherKey = "https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkKey + "/" + location[1] + "," + location[0];
            // console.log(weatherKey);
            let newData = " <table id=\"forecast\" ><tr>";
            $.get(weatherKey).done(function (weatherData) {
                // console.log(weatherData);
                // Get the three day weather
                // console.log(weatherData["daily"].data);

                let weatherForecast = weatherData["daily"].data;

                for (let i = 0; i < 3; i++) {
                    // console.log(weatherForecast[i]["icon"]);
                    // console.log(weatherIndex.indexOf(weatherForecast[i]["icon"]));
                    // console.log(weatherIcon);
                    newData += '<td>'
                    newData += '<div>  <h3 style="text-align: center">' + weatherForecast[i]["apparentTemperatureHigh"] + '/' + weatherForecast[i]["apparentTemperatureLow"]
                    newData += '</h3> <p style="align-content: center"> <img src="' + weatherIcon[weatherIndex.indexOf(weatherForecast[i]["icon"])] + '"> </p>'
                    newData += ' <div class="card-footer text-muted">'
                    newData += weatherForecast[i]["summary"] + '</div>'
                    newData += ' <div class="card-footer text-muted"><strong>Humidity: </strong>'
                    newData += weatherForecast[i]["humidity"] + '</div>';
                    newData += ' <div class="card-footer text-muted"><strong>Wind:</strong>'
                    newData += weatherForecast[i]["windSpeed"] + '</div>';
                    newData += ' <div class="card-footer text-muted"><strong>Pressure</strong>'
                    newData += weatherForecast[i]["pressure"] + '</div>';
                    newData += ' </div></td>'
                }
                // console.log(newData);
                newData += "</tr></table>";
                $("#forecast").replaceWith(newData);
            });

        }

    }
</script>
</body>
</html>